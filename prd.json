{
  "version": "1.0",
  "projectName": "atproto-agent-network-pi-loop",
  "description": "Epic #50: Real Pi Agent Loop — DO IS the Agent. Replace AI SDK with Pi, implement persistent agent config, session trees, alarm-driven autonomous loop, Pi tools, agent creation API, dashboard enhancements, and self-extending agents.",
  "stories": [
    {
      "id": "story-mlde1mhv",
      "title": "Install Pi deps + replace AI SDK wrapper",
      "description": "**REPLACE AI SDK WITH PI — STEP BY STEP**\n\n1. Install Pi packages:\n   ```bash\n   pnpm add @mariozechner/pi-ai@0.52.8 --filter @atproto-agent/network\n   pnpm add @mariozechner/pi-ai@0.52.8 @mariozechner/pi-agent-core@0.52.8 --filter @atproto-agent/agent\n   ```\n\n2. Remove AI SDK packages:\n   ```bash\n   pnpm remove ai @openrouter/ai-sdk-provider --filter @atproto-agent/network\n   ```\n\n3. Read the current ai-provider.ts:\n   ```bash\n   cat apps/network/src/ai-provider.ts\n   ```\n\n4. Write new ai-provider.ts using Pi API:\n   ```typescript\n   import { getModel, complete, type Context } from '@mariozechner/pi-ai'\n   \n   export function getOpenRouterModel(modelId: string) {\n     return getModel('openrouter', modelId)\n   }\n   \n   export async function completeWithOpenRouter(\n     model: string,\n     context: Context,\n     options?: { tools?: any[] }\n   ) {\n     const model_obj = getOpenRouterModel(model)\n     return complete(model_obj, context, options)\n   }\n   ```\n\n5. Read the current agent-factory.ts:\n   ```bash\n   cat apps/network/src/agent-factory.ts\n   ```\n\n6. Rewrite agent-factory.ts to use Pi:\n   - Replace all imports from 'ai' with imports from '@mariozechner/pi-ai'\n   - Replace generateText() calls with complete() calls\n   - Keep the factory function signature the same\n   - Maintain OpenRouter + CF AI Gateway routing\n\n7. Run tests to verify:\n   ```bash\n   pnpm test 2>&1 | tail -5\n   ```\n\n8. Run typecheck:\n   ```bash\n   pnpm typecheck\n   ```\n\nSuccess criteria:\n- All 86 tests pass\n- No imports from 'ai' package remain\n- Agent factory returns working prompt() function\n- Typecheck clean",
      "priority": 1,
      "passes": true,
      "validationCommand": "cd /home/joel/Code/joelhooks/atproto-agent-network && pnpm typecheck && pnpm test",
      "acceptanceCriteria": [
        "pnpm install succeeds with Pi packages",
        "No imports from 'ai' or '@openrouter/ai-sdk-provider' remain",
        "Agent /prompt endpoint uses Pi complete()",
        "All 86+ tests pass",
        "TypeScript compiles clean"
      ]
    },
    {
      "id": "story-mlde1tos",
      "title": "Agent config schema + DO storage",
      "description": "GitHub Issue #52. Define and persist per-agent configuration in DO storage. Create AgentConfig interface: name, personality (system prompt), specialty, model (default moonshotai/kimi-k2.5), fastModel (google/gemini-2.0-flash-001), loopIntervalMs (default 60000), goals array (AgentGoal with id/description/priority/status/progress/createdAt/completedAt), enabledTools array. Store config in DO storage under 'config' key in AgentDO (apps/network/src/agent.ts). Add GET /agents/{name}/config endpoint (returns config). Add PATCH /agents/{name}/config endpoint (partial update, merges with existing). Config is set at agent creation time and updatable at runtime. Add types to packages/core/src/types.ts or a new file. Add tests for config CRUD operations.",
      "priority": 2,
      "passes": true,
      "validationCommand": "cd /home/joel/Code/joelhooks/atproto-agent-network && pnpm typecheck && pnpm test",
      "acceptanceCriteria": [
        "AgentConfig interface defined with all fields",
        "Config persists in DO storage across requests",
        "GET /agents/{name}/config returns stored config",
        "PATCH /agents/{name}/config merges updates",
        "Tests for config storage and retrieval"
      ]
    },
    {
      "id": "story-mlde2057",
      "title": "Pi session persistence in DO storage",
      "description": "GitHub Issue #53. Persist Pi session context (messages array) in DO storage so agents maintain conversation history across alarms and DO evictions. In AgentDO (apps/network/src/agent.ts): save Pi Context messages to DO storage after each interaction under 'session' key. Load session on DO initialize(). Implement window management: keep last 50 messages in DO storage, archive overflow to D1 (agent-records). Add helper methods: loadSession(), saveSession(), trimSession(). The session should include role, content, timestamp, and any tool call results. Support Pi session branching concept (store branch points). Add tests for session save/load/trim/branch.",
      "priority": 3,
      "passes": true,
      "validationCommand": "cd /home/joel/Code/joelhooks/atproto-agent-network && pnpm typecheck && pnpm test",
      "acceptanceCriteria": [
        "Session messages persist in DO storage",
        "Session loads correctly on DO init",
        "Window management trims to 50 messages",
        "Overflow archived to D1",
        "Tests for save/load/trim"
      ]
    },
    {
      "id": "story-4a-alarm-chain",
      "title": "4a: Bare alarm chain + start/stop API",
      "description": "GitHub Issue #60. The alarm skeleton — no Pi, no inbox. Just the chain that keeps ticking. Implement alarm() handler in AgentDO that logs, increments counter, and schedules next alarm via ctx.storage.setAlarm(). Add startLoop()/stopLoop() methods. HTTP routes: POST /agents/:name/loop/start, POST /agents/:name/loop/stop, GET /agents/:name/loop/status. Safety: check loopRunning flag, reject loopIntervalMs < 5000, errors must not break chain. Files: apps/network/src/agent.ts, apps/network/src/index.ts, apps/network/src/agent-do.test.ts. Skill ref: .agents/skills/cloudflare-do (alarm patterns).\n\nAfter passing tests: deploy, smoke test, report. See AGENTS.md SHIP AND VERIFY mandate.",
      "priority": 4,
      "passes": true,
      "acceptanceCriteria": [
        "alarm() fires and reschedules",
        "startLoop()/stopLoop() work via API",
        "Error in alarm does not break chain",
        "Tests pass"
      ],
      "validationCommand": "cd /home/joel/Code/joelhooks/atproto-agent-network && pnpm typecheck && pnpm test && echo VALIDATION_PASSED"
    },
    {
      "id": "story-4b-observe",
      "title": "4b: Observe phase — inbox + event collection",
      "description": "GitHub Issue #61. Depends on #60. Implement observe() method that queries memory.list({collection: \"agent.comms.message\"}) for unread inbox messages, decrypts them, marks as processed, and collects events since last alarm. Returns structured Observations object. Wire into alarm() handler. Files: apps/network/src/agent.ts, apps/network/src/agent-do.test.ts. Skill ref: .agents/skills/envelope-encryption, .agents/skills/d1-patterns.\n\nAfter passing tests: deploy, smoke test, report. See AGENTS.md SHIP AND VERIFY mandate.",
      "priority": 5,
      "passes": true,
      "acceptanceCriteria": [
        "observe() returns structured Observations",
        "Inbox messages decrypted and collected",
        "Empty inbox handled gracefully",
        "Tests pass"
      ],
      "validationCommand": "cd /home/joel/Code/joelhooks/atproto-agent-network && pnpm typecheck && pnpm test && echo VALIDATION_PASSED"
    },
    {
      "id": "story-4c-think-act-reflect",
      "title": "4c: Think/Act/Reflect — Pi loop cycle",
      "description": "GitHub Issue #62. Depends on #60, #61. The brain: think() builds prompt from observations+goals+memories, calls Pi complete() with session context. act() executes tool calls (max 5 steps, 30s timeout). reflect() saves session, updates goals. Wire observe->think->act->reflect into alarm(). Files: apps/network/src/agent.ts, packages/agent/src/agent.ts, apps/network/src/agent-do.test.ts. Skill ref: .agents/skills/pi-agent (complete(), tools, session).\n\nTESTING APPROACH: Integration tests against real deployed worker.\n1. Unit tests for pure function logic only (if any)\n2. Integration test in apps/network/src/network.e2e.test.ts:\n   - POST /agents/test-think/loop/start with admin auth\n   - Wait for alarm to fire (~5s with min interval)\n   - GET /agents/test-think/loop/status — verify loopCount incremented\n   - Verify agent prompted Pi (check session state or response)\n   - Stop loop, verify it stops\n3. Deploy first, then run e2e against https://agent-network.joelhooks.workers.dev\n4. Use ADMIN_TOKEN from env for auth\n\nExisting unit tests in agent-do.test.ts can stay as sanity checks, but the REAL validation is the integration test passing against prod.\n\nAfter passing tests: deploy, smoke test, report. See AGENTS.md SHIP AND VERIFY mandate.",
      "priority": 6,
      "passes": true,
      "acceptanceCriteria": [
        "Pi called with correct context",
        "Tool calls executed with safety limits",
        "Session persisted after reflect",
        "Goals updated when Pi decides",
        "Tests pass"
      ],
      "validationCommand": "cd /home/joel/Code/joelhooks/atproto-agent-network && pnpm typecheck && pnpm test && echo VALIDATION_PASSED"
    },
    {
      "id": "story-4d-ws-broadcast",
      "title": "4d: WebSocket broadcast of loop events",
      "description": "GitHub Issue #63. Depends on #62. Broadcast loop lifecycle events (loop.started, loop.observe, loop.think, loop.act, loop.reflect, loop.sleep, loop.error) to connected WS clients via ctx.getWebSockets(). Events match docs/O11Y.md schema (trace_id, span_id, agent_did). Handle stale connections gracefully. Files: apps/network/src/agent.ts, apps/network/src/agent-do.test.ts.\n\nTESTING APPROACH: Real integration tests against deployed worker, NOT unit test mocks.\n1. Deploy to https://agent-network.joelhooks.workers.dev\n2. Write integration test (apps/network/src/network.e2e.test.ts or similar) that:\n   - Opens a real WebSocket to wss://agent-network.joelhooks.workers.dev/agents/test-ws/ws\n   - POSTs to /agents/test-ws/loop/start with admin auth\n   - Asserts lifecycle events arrive on the socket (loop.observe, loop.think, loop.reflect)\n   - Verifies O11Y schema (trace_id, span_id, agent_did)\n   - Tests stale connection handling (connect, disconnect, verify loop continues)\n3. Use ADMIN_TOKEN from env for auth\n4. Validation: deploy + e2e test pass against real CF\n\nDO NOT mock WebSocketPair. DO NOT use miniflare. Test against the real deployed worker.",
      "priority": 7,
      "passes": true,
      "acceptanceCriteria": [
        "Loop events broadcast to connected clients",
        "Events match O11Y schema",
        "Dead connections handled gracefully",
        "Tests pass"
      ],
      "validationCommand": "cd /home/joel/Code/joelhooks/atproto-agent-network && pnpm typecheck && pnpm test && echo VALIDATION_PASSED"
    },
    {
      "id": "story-mlde2jqb",
      "title": "Pi tool definitions",
      "description": "GitHub Issue #55. Define Pi-native tools for agents. Rewrite buildTools() in AgentDO to return Pi AgentTool format with split output (text for LLM) and details (structured for dashboard). Tools: 1) remember — store encrypted memory record, returns {output: \"Stored memory {id}\", details: {id}}. 2) recall — search memories semantically using Vectorize binding if available, fallback to list+filter, returns matching memories. 3) message — send agent.comms.message to another agent DO via RELAY namespace, includes sender DID and content. 4) search — semantic search across all agent memories on the network (query Vectorize index). 5) set_goal — add/update/complete goals on the agent config stored in DO. 6) think_aloud — record reasoning that gets broadcast via WebSocket to dashboard but NOT included in LLM context (UI-only). Each tool should have proper TypeBox or JSON Schema parameter definitions. Pi reference code: ~/Code/badlogic/pi-mono/packages/agent/src/ (agent-loop.ts, types.ts, tools/).",
      "priority": 8,
      "passes": true,
      "validationCommand": "cd /home/joel/Code/joelhooks/atproto-agent-network && pnpm typecheck && pnpm test",
      "acceptanceCriteria": [
        "All 6 tools defined with proper schemas",
        "Tools return split output/details",
        "remember tool stores encrypted memory",
        "message tool delivers to target agent DO",
        "set_goal tool updates agent config",
        "think_aloud broadcasts via WebSocket only",
        "Tests for each tool"
      ]
    },
    {
      "id": "story-mlde2raq",
      "title": "Agent creation API",
      "description": "GitHub Issue #56. API endpoint to create new agents with full config. Add POST /agents route in apps/network/src/index.ts that: 1) Validates AgentConfig schema (name required, personality required, model defaults to moonshotai/kimi-k2.5). 2) Creates DO instance using env.AGENT.idFromName(name). 3) Forwards config to DO which stores it. 4) DO starts alarm chain (first alarm = now). 5) Returns agent identity (DID, public keys, config). Add GET /agents route that lists all known agents (query D1 for registered agents or maintain a registry). Handle duplicate names (409 Conflict). Handle invalid config (400 with validation errors). Auth required (ADMIN_TOKEN bearer). Update the existing agent creation flow (currently agents are created implicitly on first request to /agents/{name}/identity).",
      "priority": 9,
      "passes": true,
      "validationCommand": "cd /home/joel/Code/joelhooks/atproto-agent-network && pnpm typecheck && pnpm test",
      "acceptanceCriteria": [
        "POST /agents creates agent with config",
        "Agent starts looping immediately after creation",
        "GET /agents lists all agents",
        "409 on duplicate name",
        "400 on invalid config",
        "Auth required",
        "Tests for creation flow"
      ]
    },
    {
      "id": "story-mlde2zb2",
      "title": "Dashboard: agent thoughts, goals, loop activity",
      "description": "GitHub Issue #57. Enhance highswarm.com dashboard (packages/dashboard/index.html) to show real agent activity. 1) Agent detail view: click agent card to expand and show current goals with status indicators, recent think_aloud output, memory count, loop status (last alarm time, next alarm, iteration count), model being used, personality snippet. 2) Live activity feed improvements: show tool calls with structured details (not just raw text), show goal updates, show inter-agent messages with sender/recipient, show think_aloud entries styled differently (italic/dimmed — internal thought). 3) Fetch agent config from GET /agents/{name}/config and display. 4) Show loop heartbeat indicator (pulsing when alarm is active). Keep the existing dark theme and monospace aesthetic. Mobile responsive.",
      "priority": 10,
      "passes": true,
      "validationCommand": "cd /home/joel/Code/joelhooks/atproto-agent-network && pnpm --filter dashboard build && pnpm typecheck",
      "acceptanceCriteria": [
        "Agent cards expand to show detail view",
        "Goals displayed with status",
        "think_aloud visible in feed",
        "Tool call details shown",
        "Loop heartbeat indicator works",
        "Dashboard builds successfully",
        "Mobile responsive"
      ]
    },
    {
      "id": "story-mlde37m4",
      "title": "Self-extending agents (R2 extension storage)",
      "description": "GitHub Issue #58. Enable agents to write their own Pi extensions stored in R2. 1) Add write_extension tool: agent provides extension name and code, stored in R2 under extensions/{agentName}/{extensionName}.js. 2) Add load_extensions() method in AgentDO: on initialize(), list R2 objects under extensions/{agentName}/, load each as a module. Extensions export an activate(agent) function that can register additional tools. 3) Extension hot-reload: after write_extension, mark that extensions need reload on next alarm cycle. 4) Add list_extensions tool: shows what extensions the agent has. 5) Add remove_extension tool: deletes from R2. 6) Safety limits: max 10 extensions per agent, max 50KB per extension, no eval() — use structured tool registration only. 7) Bootstrap: on first loop, if agent has no extensions, provide a hint in the system prompt about self-extension capability. This is the Pi philosophy: agents extend themselves rather than downloading skills.",
      "priority": 11,
      "passes": true,
      "validationCommand": "cd /home/joel/Code/joelhooks/atproto-agent-network && pnpm typecheck && pnpm test",
      "acceptanceCriteria": [
        "write_extension stores code in R2",
        "Extensions load on DO init",
        "Hot-reload works after writing",
        "list_extensions and remove_extension work",
        "Safety limits enforced",
        "Tests for extension lifecycle"
      ]
    },
    {
      "id": "story-mlepdwd0",
      "title": "Wire environment hooks into agent alarm cycle",
      "description": "GH Issue #71. Replace the Catan-specific touchpoints in agent.ts with generic environment hooks.\n\n1. **observe()** — After collecting inbox/events, iterate over agent's enabled environments via the registry in `apps/network/src/environments/`. Call `env.buildContext(ctx)` for each. Append returned context strings to observations.\n\n2. **act() assist mode** — After model tool execution, if no environment-specific action was taken, iterate enabled environments and call `env.getAutoPlayActions(ctx)`. Inject returned tool calls. The current inline D1 game query and assist injection should be delegated to the CatanEnvironment.\n\n3. **buildTools()** — Call `env.getTool(ctx)` for each enabled environment and merge into the tool set. The inline game tool definition should move to `environments/catan.ts`.\n\n4. Agent config: Add `enabledEnvironments?: string[]` to the agent config type. If present, only load those environments. This replaces checking for 'game' in enabledTools for Catan.\n\n5. Create an `EnvironmentContext` from the agent's state (name, did, DB, relay, broadcast function) and pass it to environment methods.\n\nThe result: agent.ts has ZERO Catan-specific code. All game logic lives in environments/catan.ts.\n\nIMPORTANT: The environment files already exist at `apps/network/src/environments/` — types.ts, registry.ts, catan.ts, builtins.ts. Use them. The current Catan game tool definition (~line 2100-2150 in agent.ts) and assist mode logic (~line 993-1080 in agent.ts) and think prompt game context (~line 730-800 in agent.ts) need to move into the CatanEnvironment class methods.",
      "priority": 1,
      "passes": true,
      "validationCommand": "cd /home/joel/Code/joelhooks/atproto-agent-network && npx turbo typecheck && npx vitest run --passWithNoTests",
      "acceptanceCriteria": [
        "No Catan-specific code in agent.ts",
        "observe delegates context building to environments",
        "act assist mode delegates to environments",
        "buildTools includes environment tools",
        "enabledEnvironments config option works",
        "All existing tests still pass"
      ]
    },
    {
      "id": "story-mlepe0v2",
      "title": "Environment HTTP API + backward compat",
      "description": "GH Issue #72. Update HTTP routing in `apps/network/src/index.ts` to support environments.\n\n1. `GET /environments` — list all environment instances. Supports query params: `?type=catan`, `?phase=playing`, `?player=grimlock`. Queries `games` table.\n2. `GET /environments/:id` — get specific environment instance with full state.\n3. `POST /environments` — create new environment instance. Body: `{ type: 'catan', players: ['slag', 'snarl'] }`. Delegates to the registered environment's creation logic.\n4. **Backward compat**: Keep existing `/games` and `/games/:id` routes working as aliases that filter to `type=catan`.\n5. Add environment type to the response objects.\n\nTests: verify /environments endpoints return correct data, verify /games still works.",
      "priority": 2,
      "passes": true,
      "validationCommand": "cd /home/joel/Code/joelhooks/atproto-agent-network && npx turbo typecheck && npx vitest run --passWithNoTests",
      "acceptanceCriteria": [
        "GET /environments returns environment list",
        "GET /environments/:id returns full state",
        "Query params filter by type and phase",
        "/games routes still work as aliases",
        "At least 2 endpoint tests"
      ]
    },
    {
      "id": "story-mlepe7gy",
      "title": "RPG dungeon crawl environment — BRP engine + AgentEnvironment",
      "description": "GH Issue #73. Second environment plugin — BRP-inspired RPG dungeon crawl.\n\n1. Create `apps/network/src/games/rpg-engine.ts` — pure game logic (no network deps):\n   - d100 skill resolution (roll under skill value = success)\n   - 4 classes: Warrior (STR), Scout (DEX), Mage (INT), Healer (WIS)\n   - Combat: initiative by DEX, attack vs dodge opposed roll\n   - Experience: successful skill checks improve that skill (BRP-style)\n   - Dungeon: rooms with encounters (combat, trap, treasure, rest, puzzle)\n   - Party-based: agents form party, take turns choosing actions\n\n2. Create `apps/network/src/environments/rpg.ts` implementing AgentEnvironment interface from `environments/types.ts`:\n   - `type: 'rpg'`, `label: 'Dungeon Crawl'`\n   - `getTool()` — rpg tool with commands: create_character, explore, attack, cast_spell, use_skill, rest, status\n   - `buildContext()` — current room, party health, available actions\n   - `getAutoPlayActions()` — if in combat: attack. If exploring: move to next room.\n\n3. Register RPGEnvironment in `environments/builtins.ts`.\n4. Store RPG state in `games` table with a different type field.\n\nTests: at least 8 tests covering skill checks, combat, experience gain, character creation.",
      "priority": 3,
      "passes": true,
      "validationCommand": "cd /home/joel/Code/joelhooks/atproto-agent-network && npx turbo typecheck && npx vitest run --passWithNoTests",
      "acceptanceCriteria": [
        "RPG engine handles d100 skill resolution",
        "4 classes with distinct stat spreads",
        "Combat system works with opposed rolls",
        "Experience improves skills on success",
        "RPGEnvironment implements AgentEnvironment",
        "At least 8 tests for RPG engine"
      ]
    },
    {
      "id": "story-mlepebbr",
      "title": "Dashboard: environment panel per agent",
      "description": "GH Issue #74. Add environment state display to the dashboard at `packages/dashboard/src/index.html`.\n\nWhen viewing agent detail:\n1. Fetch `GET /environments?player={agentName}` to get active environments\n2. Show environment cards: type icon, label, phase, other players, VP/HP summary\n3. For Catan: show board summary (settlements, roads, resources, VP)\n4. For RPG: show character sheet (class, HP, skills, current room)\n5. Expandable detail view with full state\n\nThe dashboard is vanilla HTML/JS, no framework. Use fetch() and DOM manipulation.",
      "priority": 4,
      "passes": true,
      "validationCommand": "cd /home/joel/Code/joelhooks/atproto-agent-network && npx turbo typecheck && npx vitest run --passWithNoTests",
      "acceptanceCriteria": [
        "Dashboard shows environment cards per agent",
        "Catan state rendered with board summary",
        "RPG state rendered with character sheet",
        "Fetches from /environments API",
        "Types pass"
      ]
    },
    {
      "id": "story-mlerh2h4",
      "title": "Stalemate detection — end Catan games early when stuck",
      "description": "Add stalemate detection to the Catan game engine. If no player has built anything (settlement or road) for N consecutive turns (suggest N=20), end the game early with the current point leader as winner.\n\nImplementation:\n1. Add `staleTurns` counter to game state (incremented on end_turn, reset to 0 when any player builds a settlement or road)\n2. In the `end_turn` action handler in `apps/network/src/games/catan.ts`, check if `staleTurns >= STALEMATE_THRESHOLD` (20). If so, set phase='finished', determine winner by highest points, set `winner` field.\n3. Add a `stalemate` field to the game-over result so agents/dashboard know it ended by stalemate vs normal victory.\n4. Write integration tests: game with forced stalemate scenario triggers early end, counter resets on build.\n\nFiles: `apps/network/src/games/catan.ts`, `apps/network/src/games/__tests__/catan.test.ts`",
      "priority": 1,
      "passes": true,
      "validationCommand": "cd /home/joel/Code/joelhooks/atproto-agent-network && npx turbo test --filter=network"
    },
    {
      "id": "story-mlerl07f",
      "title": "Agent factory o11y — full think prompt, loop transcript, and timing",
      "description": "Add comprehensive observability to the agentic tool loop in agent-factory.ts and expose it via the debug endpoint.\n\nThree things to instrument:\n\n1. **Full think prompt storage** — Store the complete messages array sent to OpenRouter in DO storage at `debug:lastPrompt`. Include system prompt + conversation history + tool definitions. Truncate if >100KB but preserve the system prompt and last 3 messages minimum. Expose via GET /agents/:name/debug as `lastPrompt`.\n\n2. **Agentic loop transcript** — In the multi-turn tool loop in `prompt()` (agent-factory.ts), record each step as an array entry:\n   ```ts\n   interface LoopStep {\n     step: number;\n     timestamp: number;\n     durationMs: number;\n     modelResponse?: { role: string; content?: string; toolCalls?: any[] };\n     toolResults?: { name: string; durationMs: number; result: any }[];\n   }\n   ```\n   Store the full transcript array in DO storage at `debug:loopTranscript`. Expose via GET /agents/:name/debug as `loopTranscript`.\n\n3. **Timing per step** — Each model call and each tool execution gets `performance.now()` before/after. Total loop duration stored at `debug:loopDurationMs`.\n\nImplementation notes:\n- All debug data written to DO storage via `this.state.storage.put()` in agent.ts after the think/act cycle completes\n- The factory `prompt()` method should return the transcript alongside the existing response (add it to the return value or store on the factory instance)\n- Debug endpoint in index.ts already reads from DO storage — extend it to include new fields\n- Keep backward compat — existing debug fields (lastThinkRaw, lastOpenRouterReq, autoPlay) remain\n\nFiles: `apps/network/src/agent-factory.ts`, `apps/network/src/agent.ts`, `apps/network/src/index.ts`, `apps/network/src/agent-do.test.ts`\n\nAcceptance criteria:\n- GET /agents/:name/debug returns lastPrompt (messages array), loopTranscript (step array with timing), loopDurationMs\n- Each tool execution in the loop has its own durationMs\n- Existing debug fields still present",
      "priority": 1,
      "passes": true,
      "validationCommand": "cd /home/joel/Code/joelhooks/atproto-agent-network && npx turbo test --filter=network"
    },
    {
      "id": "story-mlfbgtwo",
      "title": "Fix Vectorize embedding dimension mismatch (768 → 1024)",
      "description": "The search tool returns VECTOR_QUERY_ERROR: expected 1024 dimensions, got 768. Switch embedding model to bge-large-en-v1.5 (1024D) or recreate index. Test dimensions match. Files: apps/network/src/agent.ts, apps/network/wrangler.toml. IMPORTANT: Include \"Closes #76\" in your commit message body.",
      "priority": 1,
      "passes": true,
      "validationCommand": "pnpm typecheck && pnpm test"
    },
    {
      "id": "story-mlfbgyyr",
      "title": "Goal lifecycle — prune completed goals, cap prompt bloat",
      "description": "Agents accumulate completed goals forever (slag has 7, 5 completed). Max 2 recent completed in prompt, archive rest in DO storage. Add maxCompletedGoals config. Files: apps/network/src/agent.ts, apps/network/src/agent-factory.ts. IMPORTANT: Include \"Closes #77\" in your commit message body.",
      "priority": 2,
      "passes": true,
      "validationCommand": "pnpm typecheck && pnpm test"
    },
    {
      "id": "story-mlfbh5sv",
      "title": "Enforce enabledTools strictly",
      "description": "Filter tool definitions sent to OpenRouter to ONLY include tools in agent enabledTools config. Snarl called recall/search which aren't in its config. If enabledTools empty, expose all (backward compat). Files: apps/network/src/agent-factory.ts, apps/network/src/agent.ts. IMPORTANT: Include \"Closes #78\" in your commit message body.",
      "priority": 3,
      "passes": true,
      "validationCommand": "pnpm typecheck && pnpm test"
    },
    {
      "id": "story-mlfbhaur",
      "title": "Smarter error backoff — tiered by error type",
      "description": "Implement tiered backoff: transient (model timeout, rate limit) 15s→30s→60s cap. Persistent (config) 60s→120s→300s. Game-context 15s cap. Reset on success. Log error category. Files: apps/network/src/agent.ts. IMPORTANT: Include \"Closes #79\" in your commit message body.",
      "priority": 4,
      "passes": false,
      "validationCommand": "pnpm typecheck && pnpm test"
    },
    {
      "id": "story-mlfbhfmx",
      "title": "Clear stale game state on completion",
      "description": "When game ends, mark goals referencing that gameId as completed. Inject game-over observation. Next observe cycle should present clean slate. Files: apps/network/src/agent.ts, apps/network/src/catan/. IMPORTANT: Include \"Closes #80\" in your commit message body.",
      "priority": 5,
      "passes": false,
      "validationCommand": "pnpm typecheck && pnpm test"
    },
    {
      "id": "story-mlfbhk80",
      "title": "Fix /games API — return all games",
      "description": "/games returns empty array despite games existing in D1. Fix the list query. Include active and recently finished (24h). Add pagination. Files: apps/network/src/index.ts. IMPORTANT: Include \"Closes #81\" in your commit message body.",
      "priority": 6,
      "passes": false,
      "validationCommand": "pnpm typecheck && pnpm test"
    },
    {
      "id": "story-mlfbhphy",
      "title": "Structured JSON logging for all agent lifecycle events",
      "description": "Add structured console.log JSON events: agent.cycle.start/end, agent.tool.call/result, agent.error, agent.goal.update, agent.game.action/end, agent.model.fallback, agent.alarm.schedule. Create apps/network/src/logger.ts utility. Foundation for Cloudflare Pipelines. Files: apps/network/src/logger.ts (new), apps/network/src/agent-factory.ts, apps/network/src/agent.ts. IMPORTANT: Include \"Closes #82\" in your commit message body.",
      "priority": 7,
      "passes": false,
      "validationCommand": "pnpm typecheck && pnpm test"
    },
    {
      "id": "story-mlfbhwfc",
      "title": "Fix autoPlay game detection",
      "description": "Both agents show hasActiveGame=false despite active game. Fix game detection in observe/alarm cycle to reliably find games where agent is a player. Fix setup phase progression. Files: apps/network/src/agent.ts. IMPORTANT: Include \"Closes #83\" in your commit message body.",
      "priority": 8,
      "passes": false,
      "validationCommand": "pnpm typecheck && pnpm test"
    },
    {
      "id": "story-mlfbi0o4",
      "title": "Adaptive loop interval — speed up during active games",
      "description": "Implement adaptive alarm intervals: gameActiveIntervalMs (15s) when it's your turn, gameWaitingIntervalMs (45s) when waiting, default otherwise. Store reason in o11y. Files: apps/network/src/agent.ts. IMPORTANT: Include \"Closes #84\" in your commit message body.",
      "priority": 9,
      "passes": false,
      "validationCommand": "pnpm typecheck && pnpm test"
    },
    {
      "id": "story-mlfbi54u",
      "title": "Post-game summary — structured outcome logging + agent memory",
      "description": "On game completion: generate structured summary {gameId, winner, turns, durationMs, players with VP/model}. Log as agent.game.summary event. Store in agent memory via remember tool. Files: apps/network/src/catan/, apps/network/src/agent.ts. IMPORTANT: Include \"Closes #85\" in your commit message body.",
      "priority": 10,
      "passes": false,
      "validationCommand": "pnpm typecheck && pnpm test"
    }
  ],
  "metadata": {
    "createdAt": "2026-02-08T06:54:17.324Z",
    "totalIterations": 21,
    "lastIteration": "2026-02-09T15:57:04.092Z"
  },
  "totalStories": 11
}