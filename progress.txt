## CRITICAL CONTEXT FOR ALL STORIES

### Project Structure
- Monorepo: pnpm workspaces + turborepo
- `apps/network/` — Cloudflare Worker (main API + Durable Objects)
- `packages/agent/` — Agent wrapper + encrypted memory
- `packages/core/` — Crypto, identity, validation, types
- `packages/dashboard/` — highswarm.com (CF Workers Site)
- `packages/cli/` — CLI tools

### Current Architecture
- AgentDO in `apps/network/src/agent.ts` — Durable Object per agent
- `apps/network/src/agent-factory.ts` — AI SDK generateText() wrapper (REPLACE WITH PI)
- `apps/network/src/ai-provider.ts` — OpenRouter via CF AI Gateway config (KEEP GATEWAY ROUTING)
- `packages/agent/src/agent.ts` — PiAgentWrapper class
- `packages/agent/src/memory.ts` — EncryptedMemory (D1 + R2)
- RelayDO in `apps/network/src/relay.ts` — WebSocket relay

### Pi Packages (v0.52.8)
- `@mariozechner/pi-ai` — Unified LLM API: `getModel()`, `complete()`, `Context`, multi-provider handoff
- `@mariozechner/pi-agent-core` — Agent loop: `Agent`, `AgentTool`, tool execution, event streaming

### Key Rules
- NEVER hand-write package.json — use `pnpm add`
- Tests: `vitest` — run with `pnpm test` from root (86 tests across 17 files)
- Typecheck: `pnpm typecheck` from root
- Deploy: `npx wrangler deploy` in apps/network or packages/dashboard
- CF AI Gateway URL: `https://gateway.ai.cloudflare.com/v1/{accountId}/{slug}/openrouter`
- Default model: `moonshotai/kimi-k2.5` (reasoning), `google/gemini-2.0-flash-001` (fast)
- All agents have DIDs, Ed25519 signing keys, X25519 encryption keys

### Design Doc
See `docs/AGENT-LOOP-DESIGN.md` for full architecture

### Deployed Resources
- Worker: agent-network-production.joelhooks.workers.dev
- D1: agent-records (98bf7535-be31-42cb-a4fa-0767d294b5f1)
- R2: agent-blobs
- Vectorize: agent-memory (1024 dims, cosine)
- Queue: agent-messages
- Live agents: grimlock, scout (with DIDs + keys)

### DO NOT
- Do NOT remove existing test files or break the 86 passing tests
- Do NOT change the wrangler.toml bindings without understanding the deployed resources
- Do NOT use `ai` (Vercel AI SDK) package after story 1 replaces it with Pi
- Do NOT create mock/stub implementations — use real Pi APIs

---
[2026-02-08T07:06:24.668Z]
Failed: Install Pi deps + replace AI SDK wrapper [build_error]
Validation: 
> atproto-agent-network@ typecheck /home/joel/Code/joelhooks/atproto-agent-network
> turbo typecheck

• Packages in scope: @atproto-agent/agent, @atproto-agent/cli, @atproto-agent/core, @atproto-agent/dashboard, @atproto-agent/network
• Running typecheck in 5 packages
• Remote caching disabled
@atp
Codex: 

---
[INTERVENTION] Story 1 is taking too long. SKIP reading PI-POC.md, O11Y.md, and skills.
Focus ONLY on:
1. Run: pnpm add @mariozechner/pi-ai @mariozechner/pi-agent-core --filter @atproto-agent/agent
2. Run: pnpm add @mariozechner/pi-ai --filter @atproto-agent/network
3. Read apps/network/src/agent-factory.ts and apps/network/src/ai-provider.ts
4. Rewrite them to use Pi's API instead of AI SDK
5. Update imports, remove old deps
6. Run validation

Pi API quick reference:
- import { getModel, complete } from '@mariozechner/pi-ai'
- const model = getModel('openrouter', 'moonshotai/kimi-k2.5')
- const response = await complete(model, context, { tools })
- Context = { messages: Array<{role: string, content: string}> }

DO NOT spend time reading unrelated docs. Just swap the deps and make tests pass.

---
[2026-02-08T07:16:49.457Z]
Failed: Install Pi deps + replace AI SDK wrapper [build_error]
Validation: 
> atproto-agent-network@ typecheck /home/joel/Code/joelhooks/atproto-agent-network
> turbo typecheck

• Packages in scope: @atproto-agent/agent, @atproto-agent/cli, @atproto-agent/core, @atproto-agent/dashboard, @atproto-agent/network
• Running typecheck in 5 packages
• Remote caching disabled
@atp
Codex: 

---
[2026-02-08T07:17:37.119Z]
Completed: Install Pi deps + replace AI SDK wrapper
Files: none
Summary: Next: removing `ai` and `@openrouter/ai-sdk-provider` from `@atproto-agent/network`, then rewriting `apps/network/src/ai-provider.ts` and `apps/network/src/agent-factory.ts` to use Pi’s `getModel` + `complete`.

---
[2026-02-08T07:27:59.173Z]
Failed: Agent config schema + DO storage [build_error]
Validation: 
> atproto-agent-network@ typecheck /home/joel/Code/joelhooks/atproto-agent-network
> turbo typecheck

• Packages in scope: @atproto-agent/agent, @atproto-agent/cli, @atproto-agent/core, @atproto-agent/dashboard, @atproto-agent/network
• Running typecheck in 5 packages
• Remote caching disabled
@atp
Codex: 

---
[2026-02-08T07:38:26.712Z]
Failed: Install Pi deps + replace AI SDK wrapper [test_failure]
Validation: 
> atproto-agent-network@ typecheck /home/joel/Code/joelhooks/atproto-agent-network
> turbo typecheck

• Packages in scope: @atproto-agent/agent, @atproto-agent/cli, @atproto-agent/core, @atproto-agent/dashboard, @atproto-agent/network
• Running typecheck in 5 packages
• Remote caching disabled
@atp
Codex: 

---
[2026-02-08T07:48:51.754Z]
Failed: Install Pi deps + replace AI SDK wrapper [build_error]
Validation: 
> atproto-agent-network@ typecheck /home/joel/Code/joelhooks/atproto-agent-network
> turbo typecheck

• Packages in scope: @atproto-agent/agent, @atproto-agent/cli, @atproto-agent/core, @atproto-agent/dashboard, @atproto-agent/network
• Running typecheck in 5 packages
• Remote caching disabled
@atp
Codex: 

---
[2026-02-08T07:54:40.523Z]
Completed: Install Pi deps + replace AI SDK wrapper
Files: none
Summary: Completed Pi swap for the network AI wrapper/factory.

- Pi deps are in place: `apps/network/package.json` uses `@mariozechner/pi-ai@0.52.8`; `packages/agent/package.json` uses `@mariozechner/pi-ai@0.52.8` + `@mariozechner/pi-agent-core@0.52.8`.
- AI SDK is gone from runtime TS: `rg "from 'ai'|@openrouter/ai-sdk-provider" --glob '*.ts'` returns no matches.
- `apps/network/src/ai-provider.ts` route

---
[2026-02-08T07:58:58.075Z]
Completed: Agent config schema + DO storage
Files: none
Summary: Prior failure pattern detected: `build_error`/`unknown` with “no output captured”. Mitigation: run `pnpm typecheck` and `pnpm test` unpiped (no `| grep -q`) to surface real errors; both now pass.

Implemented (already present in the workspace) for Issue #52 / story `story-mlde1tos`:
- Types: `AgentGoalStatus`, `AgentGoal`, `AgentConfig` in `packages/core/src/types.ts`.
- DO persistence: `AgentDO` 
