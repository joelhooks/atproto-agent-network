# atproto-agent-network Progress

## Project Overview
Private-by-default encrypted memory network for AI agents on AT Protocol.
GitHub: joelhooks/atproto-agent-network

## ⚠️ CRITICAL LEARNINGS FROM PREVIOUS LOOPS — READ BEFORE CODING

### Architecture & File Layout
- **Monorepo**: pnpm workspaces + turborepo. Packages: `core`, `agent`, `cli`, `dashboard`. App: `network`
- **Package manager**: pnpm ONLY. Never use npm/yarn. Use `pnpm add <pkg>` from CLI, never hand-edit package.json deps
- **Test runner**: vitest with workspace config. Run `pnpm test` from root. 73 tests passing, 2 E2E skipped
- **Validation**: `pnpm test` is the validation command. It MUST pass before committing

### Existing Code Map (DO NOT DUPLICATE OR BREAK)
- `packages/core/src/crypto.ts` — X25519/Ed25519 keypair gen, envelope encryption (DEK), deriveSharedSecret. Uses WebCrypto API. Keys exported as JWK format.
- `packages/core/src/identity.ts` — DID generation, identity management
- `packages/core/src/validation.ts` — Zod schemas for lexicon validation (MemoryRecord, SharedRecord, InboxMessage)
- `packages/core/src/d1-mock.ts` — D1 database mock for testing (createD1Mock helper)
- `packages/core/src/test-utils.ts` — Test fixtures: createTestAgent(), createTestMemory(), createTestEnvelope()
- `packages/core/src/types.ts` — Core TypeScript types
- `packages/core/src/lexicons.ts` — AT Protocol lexicon definitions
- `packages/agent/src/memory.ts` — EncryptedMemory class with create/read/list/update/softDelete operations
- `packages/agent/src/agent.ts` — Pi agent wrapper
- `apps/network/src/index.ts` — Main worker with routes: /store, /read, /list, /update, /delete, /share, /shared, /inbox, /inbox/send, /register, /lookup, /subscribe
- `apps/network/src/agent.ts` — AgentDO (Durable Object) implementation
- `apps/network/src/relay.ts` — RelayDO with subscription filtering, firehose fanout
- `apps/network/src/auth.ts` — Bearer token auth middleware (requireAuth helper)
- `apps/network/src/cors.ts` — CORS middleware
- `apps/network/src/http-errors.ts` — Error handling wrappers (handleRouteError, AppError)
- `apps/network/src/http-validation.ts` — HTTP request validation using Zod schemas

### Key Patterns Discovered
1. **D1 mock**: Use `createD1Mock()` from `@atproto-agent/core/test-utils` — it returns a mock D1Database that works with prepared statements
2. **Auth pattern**: `requireAuth(request, env)` throws 401 if no valid bearer token. Token validated against env.AUTH_SECRET
3. **Error handling**: All routes wrapped in try/catch using `handleRouteError(error)` which returns proper HTTP responses
4. **Validation**: Request bodies validated with Zod schemas from `@atproto-agent/core/validation` before processing
5. **Encryption flow**: Generate keypair → export public key (multibase) → derive shared secret → envelope encrypt with DEK
6. **WebSocket**: AgentDO and RelayDO both have webSocketMessage/webSocketClose handlers. RelayDO fans out to subscribers
7. **CORS**: All responses include CORS headers via `addCorsHeaders()` middleware
8. **Tests are TDD**: Write test FIRST, then implementation. Every new feature needs tests.

### Common Pitfalls (AVOID THESE)
- ❌ Do NOT use `npm install` or `yarn add` — only `pnpm add`
- ❌ Do NOT create fake/stub workspace packages — use real npm packages
- ❌ Do NOT modify vitest.workspace.ts — it's deprecated, use vitest.config.ts projects field
- ❌ Do NOT use `--frozen-lockfile` in validation if the story might update deps
- ❌ Do NOT break existing tests — run `pnpm test` before committing
- ❌ Do NOT duplicate functionality that already exists in core/agent packages
- ❌ E2E tests (network.e2e.test.ts) are SKIPPED — they need @cloudflare/vitest-pool-workers migration

### What's Already Done (passes: true)
- Setup monorepo, vitest, identity tests, workspace config, turbo tasks
- Test utilities and fixtures, CI workflow, pre-commit hooks
- X25519, Ed25519 keypairs, exportPublicKey, deriveSharedSecret
- Envelope encryption, D1 schema, Pi agent wrapper, EncryptedMemory
- AgentDO wiring, integration/E2E test harnesses
- Lexicon validation, memory CRUD, shared records
- Relay agent registry, agent inbox, error handling
- Relay subscription filtering, WebSocket handlers
- Auth middleware, CORS headers, D1 mock consolidation
- Key serialization fix (JWK), lockfile fix, turbo stubs fix

### What Remains (passes: false — YOUR WORK)
These stories need implementation. Check existing code first — some may already be partially done:
- Testing infrastructure stories (vitest already installed and working)
- Crypto primitive stories (crypto.ts already has full implementation)
- Storage/schema stories (D1 schema, EncryptedMemory already exist)
- Advanced integration stories

**IMPORTANT**: Many "remaining" stories may already be implemented from loop 1. If validation passes without changes, commit with a note that it was already done. Don't re-implement existing code.

---
[2026-02-08T01:56:47.757Z]
Completed: Install Vitest and create root config
Files: none
Summary: Vitest is installed at the workspace root and a root multi-project config is in place; validation passes.

**Changes (and why)**
- `package.json`: added `@vitest/coverage-v8` dev dependency (coverage provider for root config).
- `pnpm-lock.yaml`: lockfile updated for the new dev dependency.
- `vitest.config.ts`: switched to `test.projects` (workspace-style multi-project runner).
- `vitest.workspac

---
[2026-02-08T01:58:05.396Z]
Completed: Install Vitest and create root config
Files: none
Summary: Vitest + root config are already in place, and the story’s validation now passes.

- Root config: `vitest.config.ts` (multi-project via `test.projects`)
- Vitest install: `package.json` includes `vitest` + `@vitest/coverage-v8`
- Validation: `pnpm test --pass-with-no-tests ... || pnpm vitest run --passWithNoTests` runs and passes (`pnpm vitest run --passWithNoTests` executed successfully)

**Files

---
[2026-02-08T01:59:46.483Z]
Completed: Create first unit test for identity.ts
Files: none
Summary: - `packages/core/src/identity.test.ts` already exists (covers `createDid`/`parseDid`, federated DID parsing, and `generateTid`), and the repo already has commit `751d108 ralph: Create first unit test for identity.ts`.
- Validation: `pnpm vitest run packages/core/src/identity.test.ts` (passes: 4/4).

**Files modified (and why)**
- None for this story.

**Tests added/modified**
- None; existing `pac

---
[2026-02-08T02:03:39.382Z]
Completed: Create vitest workspace config for monorepo
Files: none
Summary: Validation passes already: `pnpm vitest run --filter @atproto-agent/core` runs only the `@atproto-agent/core` project and passes.

**Files modified (and why)**
- None (workspace-style multi-project setup is already in place via `vitest.config.ts`, per-package `packages/*/vitest.config.ts`, and the wrapper `scripts/vitest.mjs`).

**Tests added/modified**
- None.

**What I learned**
- This repo’s `p
